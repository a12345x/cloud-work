<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ•™å¸ˆç®¡ç†</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* âœ… å¢åŠ æœ¬åœ°æ ·å¼ï¼šæŒ‰é’®ç¦ç”¨çŠ¶æ€ */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* âœ… åŠ è½½çŠ¶æ€ */
        .loading {
            color: #007acc;
            font-style: italic;
        }
        /* âœ… æ¶ˆæ¯å®¹å™¨ç»Ÿä¸€é£æ ¼ */
        #message {
            margin-top: 1rem;
            min-height: 1.5rem;
        }
        /* âœ… è°ƒè¯•ä¿¡æ¯æ ·å¼ï¼ˆç”Ÿäº§ç¯å¢ƒå¯åˆ é™¤ï¼‰ */
        .debug-info {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: none; /* ğŸ” å‘å¸ƒæ—¶è®¾ä¸º none */
        }

        /* âœ… å¯ç¼–è¾‘æˆç»©å•å…ƒæ ¼æ ·å¼ */
        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable:hover {
            background-color: #f0f8ff;
        }
        .editing {
            border: 2px solid #007acc;
            padding: 2px;
            text-align: center;
            border-radius: 4px;
            outline: none;
            width: 60px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        .form-group {
            margin-bottom: 0.8rem;
        }
        label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
        }
        input, select, button {
            padding: 0.5rem;
            font-size: 1rem;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover:not(:disabled) {
            background-color: #005a99;
        }
        .error {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
        .info {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html" onclick="logout()">é€€å‡º</a>
        </nav>
        <h1>ğŸ‘¨ğŸ« æ•™å¸ˆç®¡ç†åå°</h1>

        <!-- ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šå‘å¸ƒå‰å¯éšè— -->
        <div id="debugInfo" class="debug-info"></div>

        <div id="userInfo"></div>

        <!-- è®¾ç½®æŸ¥çœ‹æœŸ -->
        <h2>ğŸ“… è®¾ç½®æˆç»©æŸ¥çœ‹æœŸ</h2>
        <div class="form-group">
            <label for="startTime">å¼€å§‹æ—¶é—´</label>
            <input type="datetime-local" id="startTime" />
        </div>
        <div class="form-group">
            <label for="endTime">ç»“æŸæ—¶é—´</label>
            <input type="datetime-local" id="endTime" />
        </div>
        <button type="button" id="setPeriodBtn">è®¾ç½®</button>

        <!-- ä¸Šä¼ æˆç»© -->
        <h2>ğŸ“¤ ä¸Šä¼ æˆç»©æ–‡ä»¶</h2>
        <div class="form-group">
            <input type="file" id="gradeFile" accept=".csv,.xlsx" />
        </div>
        <button type="button" id="uploadBtn">ä¸Šä¼ </button>

        <!-- æŸ¥çœ‹ç§‘ç›®æˆç»© -->
        <h2>ğŸ“Š æŸ¥çœ‹ç§‘ç›®æˆç»©</h2>
        <div class="form-group">
            <label for="subjectSelect">é€‰æ‹©ç§‘ç›®</label>
            <select id="subjectSelect">
                <option value="">-- è¯·é€‰æ‹©ç§‘ç›® --</option>
            </select>
        </div>
        <button type="button" id="queryBtn">æŸ¥è¯¢</button>

        <table id="subjectTable" style="display:none; margin-top: 1rem;">
            <thead>
                <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>æˆç»©</th>
                    <th>å­¦æœŸ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="message"></div>
    </div>

    <!-- âœ… å¼•å…¥ Papa Parse ç”¨äº CSV é¢„å¤„ç†ï¼ˆä»…ç”¨äºå­—æ®µæ˜ å°„æç¤ºï¼Œä¸ç”¨äºä¸Šä¼ ï¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- âœ… ä½¿ç”¨ module æ¨¡å¼å¯¼å…¥ -->
    <script type="module">
        import { Api, logout } from './api.js';

        // ğŸ” å®‰å…¨æ ¡éªŒç™»å½•çŠ¶æ€ï¼ˆå¢å¼ºç‰ˆï¼‰
        const userRaw = localStorage.getItem('user');
        const token = localStorage.getItem('token');
        const debugDiv = document.getElementById('debugInfo');

        // âœ… å¼€å‘è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰ localStorage çŠ¶æ€
        if (debugDiv) {
            debugDiv.innerHTML = `
                <strong>è°ƒè¯•ä¿¡æ¯ï¼ˆå‘å¸ƒå‰è¯·éšè—ï¼‰:</strong><br>
                user: ${userRaw ? JSON.stringify(userRaw) : 'null'}<br>
                token å­˜åœ¨: ${!!token}<br>
                URL: ${window.location.href}
            `;
        }

        // âœ… æ£€æŸ¥æ˜¯å¦ç™»å½•
        if (!userRaw || !token) {
            if (!userRaw) console.warn('âŒ localStorage.user ä¸å­˜åœ¨');
            if (!token) console.warn('âŒ localStorage.token ä¸å­˜åœ¨');
            alert('è¯·å…ˆç™»å½•');
            window.location.href = 'index.html';
            throw new Error('æœªç™»å½•');
        }

        let user;
        try {
            user = JSON.parse(userRaw);
        } catch (e) {
            console.error('âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥:', e);
            alert('ç”¨æˆ·æ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
            logout();
            window.location.href = 'index.html';
            throw e;
        }

        // âœ… ä¸¥æ ¼æ£€æŸ¥è§’è‰²ï¼šå»é™¤ç©ºæ ¼ã€è½¬å°å†™ï¼Œé˜²æ­¢ 'teacher ' æˆ– 'Teacher'
        const role = (user.role || '').trim().toLowerCase();
        if (role !== 'teacher') {
            console.warn('âŒ è§’è‰²æ ¡éªŒå¤±è´¥:', { rawRole: user.role, normalized: role });
            alert('æƒé™ä¸è¶³ï¼Œä»…æ•™å¸ˆå¯è®¿é—®');
            window.location.href = 'index.html';
            throw new Error('è§’è‰²ä¸åŒ¹é…');
        }

        // âœ… æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        document.getElementById('userInfo').innerHTML = `
            <p><strong>æ•™å¸ˆï¼š</strong>${user.name || 'æœªçŸ¥'}</p>
            <p><small>ID: ${user.id || 'æœªçŸ¥'}</small></p>
        `;

        let subjects = [];

        // âœ… åŠ è½½æ•™å¸ˆä¿¡æ¯ï¼ˆå«ç§‘ç›®ï¼‰
        async function loadTeacherInfo() {
            const msg = document.getElementById('message');
            msg.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•™å¸ˆä¿¡æ¯...</div>';

            try {
                const res = await Api.getTeacherInfo(user.id);
                if (res.error) {
                    throw new Error(res.error);
                }

                subjects = Array.isArray(res.subjects) ? res.subjects : [];
                const sel = document.getElementById('subjectSelect');
                
                if (subjects.length === 0) {
                    sel.innerHTML = '<option value="">-- æš‚æ— ç§‘ç›® --</option>';
                    sel.disabled = true;
                } else {
                    sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç§‘ç›® --</option>';
                    subjects.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        sel.appendChild(opt);
                    });
                    sel.disabled = false;
                }

                msg.innerHTML = '';
            } catch (err) {
                msg.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${err.message}</div>`;
                console.error('âŒ åŠ è½½æ•™å¸ˆä¿¡æ¯å¤±è´¥:', err);
            }
        }

        // âœ… è®¾ç½®æŸ¥çœ‹æœŸ
        async function setViewPeriod() {
            const startInput = document.getElementById('startTime').value;
            const endInput = document.getElementById('endTime').value;
            const btn = document.getElementById('setPeriodBtn');
            const msg = document.getElementById('message');

            if (!startInput || !endInput) {
                msg.innerHTML = `<div class="error">è¯·å¡«å†™å®Œæ•´çš„å¼€å§‹å’Œç»“æŸæ—¶é—´</div>`;
                return;
            }

            // âœ… æ ¼å¼åŒ–ä¸º ISO æ—¶é—´ï¼ˆUTCï¼‰
            const start = new Date(startInput).toISOString();
            const end = new Date(endInput).toISOString();

            if (new Date(end) <= new Date(start)) {
                msg.innerHTML = `<div class="error">ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´</div>`;
                return;
            }

            // âœ… é˜²é‡å¤æäº¤
            btn.disabled = true;
            btn.textContent = 'è®¾ç½®ä¸­...';

            try {
                const res = await Api.setViewPeriod(user.id, start, end);
                if (res.error) throw new Error(res.error);

                msg.innerHTML = `<div class="success">âœ… æˆåŠŸè®¾ç½®æˆç»©æŸ¥çœ‹æœŸï¼</div>`;
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';
            } catch (err) {
                msg.innerHTML = `<div class="error">âŒ è®¾ç½®å¤±è´¥: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'è®¾ç½®';
            }
        }

        // âœ… æå–å…¬å…±å“åº”å¤„ç†é€»è¾‘
        function handleUploadResponse(res, msg, fileInput, btn) {
            let messageHTML = '';

            if (res.successCount !== undefined) {
                if (res.failureCount === 0) {
                    messageHTML = `<div class="success">ğŸ‰ æˆåŠŸä¸Šä¼  ${res.successCount} æ¡æˆç»©ï¼</div>`;
                } else {
                    messageHTML = `
                        <div class="info">âš ï¸ å·²å¤„ç† ${res.successCount + res.failureCount} æ¡ï¼ŒæˆåŠŸ: ${res.successCount}ï¼Œå¤±è´¥: ${res.failureCount}</div>
                    `;
                    if (res.failures && res.failures.length > 0) {
                        messageHTML += `<div class="error"><strong>ğŸ“Œ å¤±è´¥è¯¦æƒ…ï¼š</strong><ul>`;
                        res.failures.forEach(fail => {
                            const sid = fail.row?.studentId || 'æœªçŸ¥';
                            const err = fail.error || 'æœªçŸ¥é”™è¯¯';
                            messageHTML += `<li>å­¦å· <strong>${sid}</strong>: ${err}</li>`;
                        });
                        messageHTML += `</ul></div>`;
                    }
                }
                fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            } else {
                messageHTML = `<div class="error">âŒ ä¸Šä¼ å¤±è´¥: ${res.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
            }

            msg.innerHTML = messageHTML;
            btn.disabled = false;
            btn.textContent = 'ä¸Šä¼ ';
        }

        // âœ… ç»Ÿä¸€æ–‡ä»¶è½¬ Base64ï¼ˆä¿æŒäºŒè¿›åˆ¶å®Œæ•´æ€§ï¼‰
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1]; // å»æ‰ data URL å‰ç¼€
                    resolve(base64Data);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file); // âœ… æ­£ç¡®æ–¹å¼ï¼Œä¿ç•™åŸå§‹äºŒè¿›åˆ¶
            });
        }

        // âœ… ä¸Šä¼ æˆç»©ï¼ˆç»Ÿä¸€ä½¿ç”¨ Base64 ä¸Šä¼ åŸå§‹æ–‡ä»¶ï¼‰
        async function uploadGrades() {
            const fileInput = document.getElementById('gradeFile');
            const btn = document.getElementById('uploadBtn');
            const msg = document.getElementById('message');

            if (!fileInput.files[0]) {
                msg.innerHTML = `<div class="error">è¯·é€‰æ‹©æ–‡ä»¶</div>`;
                return;
            }

            const file = fileInput.files[0];
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                msg.innerHTML = `<div class="error">æ–‡ä»¶è¿‡å¤§ï¼ˆæœ€å¤§ 5MBï¼‰</div>`;
                return;
            }

            const validTypes = ['text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            if (!validTypes.includes(file.type)) {
                msg.innerHTML = `<div class="error">ä»…æ”¯æŒ .csv æˆ– .xlsx æ–‡ä»¶</div>`;
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ä¸Šä¼ ä¸­...';

            try {
                // âœ… ç»Ÿä¸€ä½¿ç”¨ Base64 ä¸Šä¼ åŸå§‹æ–‡ä»¶
                const base64 = await fileToBase64(file);
                const fileType = file.name.endsWith('.xlsx') ? 'xlsx' : 'csv'; // åç«¯æ ¹æ®æ‰©å±•ååˆ¤æ–­

                const res = await Api.uploadGrades(user.id, base64, fileType);
                handleUploadResponse(res, msg, fileInput, btn);
            } catch (err) {
                msg.innerHTML = `<div class="error">æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
                btn.disabled = false;
                btn.textContent = 'ä¸Šä¼ ';
            }
        }

        // âœ… ä¿å­˜æˆç»©ï¼ˆè°ƒç”¨åç«¯ï¼‰
        async function saveGrade(studentId, subject, semester, newGrade) {
            const msg = document.getElementById('message');

            // âœ… æ ¡éªŒæˆç»©èŒƒå›´
            const gradeNum = parseFloat(newGrade);
            if (isNaN(gradeNum) || gradeNum < 0 || gradeNum > 100) {
                msg.innerHTML = `<div class="error">æˆç»©å¿…é¡»æ˜¯ 0~100 ä¹‹é—´çš„æ•°å­—</div>`;
                return false;
            }

            try {
                const res = await Api.updateGrade(studentId, subject, gradeNum, semester);
                if (res.error) {
                    throw new Error(res.error);
                }
                msg.innerHTML = `<div class="success">âœ… æˆç»©å·²æ›´æ–°</div>`;
                return true;
            } catch (err) {
                msg.innerHTML = `<div class="error">âŒ ä¿å­˜å¤±è´¥: ${err.message}</div>`;
                return false;
            }
        }

        // âœ… ç¼–è¾‘æˆç»©ï¼ˆç‚¹å‡»è§¦å‘ï¼‰
        function editGrade(studentId, subject, semester, currentGrade) {
            const cell = event.target;
            if (cell.tagName !== 'TD') return;

            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentGrade;
            input.min = 0;
            input.max = 100;
            input.step = 0.5;
            input.className = 'editing';

            // ä¿å­˜æ—§å€¼
            const oldValue = currentGrade;

            // æ›¿æ¢æ–‡æœ¬ä¸ºè¾“å…¥æ¡†
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();

            // âœ… å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            async function onBlur() {
                input.removeEventListener('blur', onBlur);
                input.removeEventListener('keydown', onKey);

                const newValue = input.value.trim();
                const saved = await saveGrade(studentId, subject, semester, newValue);
                if (!saved) {
                    // ä¿å­˜å¤±è´¥ï¼Œæ¢å¤åŸå€¼
                    cell.innerHTML = `<strong>${oldValue}</strong>`;
                } else {
                    cell.innerHTML = `<strong>${newValue}</strong>`;
                }
            }

            // âœ… Enter é”®ä¿å­˜ï¼ŒEscape å–æ¶ˆ
            function onKey(e) {
                if (e.key === 'Enter') {
                    onBlur();
                } else if (e.key === 'Escape') {
                    cell.innerHTML = `<strong>${oldValue}</strong>`;
                    input.remove();
                }
            }

            input.addEventListener('blur', onBlur);
            input.addEventListener('keydown', onKey);
        }

        // âœ… æŸ¥è¯¢ç§‘ç›®æˆç»©ï¼ˆæ”¯æŒç‚¹å‡»ç¼–è¾‘ï¼‰
        async function loadSubjectGrades() {
            const subject = document.getElementById('subjectSelect').value;
            const btn = document.getElementById('queryBtn');
            const table = document.getElementById('subjectTable');
            const tbody = table.querySelector('tbody');
            const msg = document.getElementById('message');

            if (!subject) {
                msg.innerHTML = `<div class="error">è¯·é€‰æ‹©ç§‘ç›®</div>`;
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';

            try {
                const res = await Api.getSubjectGrades(user.id, subject);
                if (res.error) throw new Error(res.error);

                if (!res.grades || res.grades.length === 0) {
                    msg.innerHTML = `<div class="info">ğŸ“Œ è¯¥ç§‘ç›®æš‚æ— æˆç»©æ•°æ®ã€‚</div>`;
                    table.style.display = 'none';
                } else {
                    tbody.innerHTML = ''; // æ¸…ç©ºæ—§æ•°æ®

                    res.grades.forEach(g => {
                        const grade = g.grade != null ? g.grade : '';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${g.student_id || '-'}</td>
                            <td>${g.name || 'æœªçŸ¥'}</td>
                            <td class="editable" title="ç‚¹å‡»ç¼–è¾‘æˆç»©"><strong>${grade}</strong></td>
                            <td>${g.semester || 'æœªçŸ¥'}</td>
                        `;

                        // âœ… ç»‘å®šäº‹ä»¶ï¼šä½¿ç”¨é—­åŒ…æ•è·å½“å‰ g çš„å€¼
                        tr.querySelector('td.editable').addEventListener('click', () => {
                            editGrade(g.student_id, subject, g.semester, grade);
                        });

                        tbody.appendChild(tr);
                    });

                    table.style.display = 'table';
                    msg.innerHTML = `<div class="success">å…±åŠ è½½ ${res.grades.length} æ¡æˆç»©</div>`;
                }
            } catch (err) {
                msg.innerHTML = `<div class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${err.message}</div>`;
                table.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢';
            }
        }

        // âœ… ç»‘å®šäº‹ä»¶
        document.getElementById('setPeriodBtn').addEventListener('click', setViewPeriod);
        document.getElementById('uploadBtn').addEventListener('click', uploadGrades);
        document.getElementById('queryBtn').addEventListener('click', loadSubjectGrades);

        // âœ… åˆå§‹åŒ–
        loadTeacherInfo();
    </script>
</body>
</html>