<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æˆç»©ç®¡ç†ç³»ç»Ÿ - ç™»å½•</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="data:," />
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æˆç»©ç®¡ç†ç³»ç»Ÿ</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="id">å­¦å·/å·¥å·</label>
                <input type="text" id="id" required placeholder="è¯·è¾“å…¥ID" />
            </div>
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" required placeholder="è¯·è¾“å…¥å¯†ç " />
            </div>
            <button type="submit">ç™»å½•</button>
        </form>
        <div id="message"></div>
    </div>

    <script type="module">
        import { Api } from './api.js';

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('id').value.trim();
            const password = document.getElementById('password').value;
            const msg = document.getElementById('message');

            msg.innerHTML = '';

            try {
                // æ¸…é™¤æ—§ token
                localStorage.removeItem('token');
                const res = await Api.login(id, password);

                console.log('ç™»å½•å“åº”:', res); // ğŸ” è°ƒè¯•

                if (res.success) {
                    const user = res.user;
                    const token = res.token;

                    // âœ… ä¸¥æ ¼æ ¡éªŒ user å’Œ token
                    if (!user || !token) {
                        throw new Error('ç™»å½•å“åº”ç¼ºå°‘ç”¨æˆ·æˆ–ä»¤ç‰Œ');
                    }

                    // âœ… æ ¡éªŒ role æ˜¯å¦å­˜åœ¨
                    if (!user.role) {
                        throw new Error('ç”¨æˆ·è§’è‰²ä¿¡æ¯ç¼ºå¤±');
                    }

                    // âœ… ç»Ÿä¸€å¤„ç† roleï¼šè½¬å°å†™ + å»ç©ºæ ¼
                    const role = String(user.role).trim().toLowerCase();

                    // ä¿å­˜
                    localStorage.setItem('user', JSON.stringify(user));
                    localStorage.setItem('token', token);

                    // âœ… è·³è½¬é€»è¾‘å¢å¼º
                    if (role === 'student') {
                        window.location.href = 'student.html';
                    } else if (role === 'teacher') {
                        window.location.href = 'teacher.html';
                    } else if (role === 'admin') {
                        window.location.href = 'admin.html';
                    } else {
                        msg.innerHTML = `<div class="error">æƒé™ä¸è¶³ï¼šæœªçŸ¥è§’è‰² "${user.role}"</div>`;
                    }
                } else {
                    msg.innerHTML = `<div class="error">${res.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç '}</div>`;
                }
            } catch (err) {
                console.error('ç™»å½•å¼‚å¸¸:', err);
                msg.innerHTML = `<div class="error">ç™»å½•å¤±è´¥ï¼š${err.message || 'ç½‘ç»œé”™è¯¯'}</div>`;
            }
        });
    </script>
</body>
</html>